#  Custom Vision Demo
サービスイン当初は分類器のみでしたが、5/7のアップデートで物体検出（特定部分の座標取得）ができるようになりました。仕事で軽くプロトタイプを作ってみたところ、そこそこ使えそうな精度になったのでプライベート向けの題材で学習して公開してみることにしました。

# 東方Projectのキャラ判定機を作ろう

物体検出の題材として、学習データの分量を用意できることが必須かつ「分類することの意味」にもこだわってみたかったので東方キャラを題材に選んでみました。学習材料は自宅にある薄い本＋公式書籍＋αとなっております。
作業を簡略化するため、下記の条件に当てはまる箇所を撮影して学習データを用意します。

- 表紙
- 裏表紙
- フルカラー

## 1.学習データを準備

1. ログイン後、規約に同意してプロジェクト作成を選択すると、下のような画像アップロード画面に移動します。
![001.JPG](https://qiita-image-store.s3.amazonaws.com/0/129156/a4b1a96d-bf2b-698e-1ed9-c3d1be7cbae4.jpeg)

2. 学習データ（薄い本）を用意して１枚づつ裏表紙を撮影していきます。
![DSC_1076.JPG](https://qiita-image-store.s3.amazonaws.com/0/129156/9864e48e-0022-05ac-482f-dc36dbdf6d7b.jpeg)

3. アップロードします
![002.JPG](https://qiita-image-store.s3.amazonaws.com/0/129156/0158b2ab-670e-2416-3418-f390d37eb638.jpeg)

4. ドラッグ＆ドロップでエリア選択をして、タグ付けします
![003.JPG](https://qiita-image-store.s3.amazonaws.com/0/129156/60bad938-7746-cef6-5de3-a25a50dabc17.jpeg)

基本的にすべてマニュアル作業となりますが、編集画面で物体検出を自動でやってくれたりして結構スマートです。点線は自動検出部分。
![004.JPG](https://qiita-image-store.s3.amazonaws.com/0/129156/955dc919-f797-b0f8-d994-1d0bfbf0e282.jpeg)

## 2.学習させる

右上の「Train」ボタンを押すだけ…なのですが1タグあたり15枚以上の画像が必須となっているので、微妙に足りないキャラの学習データをフルカラーイラスト集から追加したり、全く足りないキャラのタグを削除したりします。
そもそも50タグが無料版の限界なので、東方キャラ全員の検知は不可能ですね…

![005.JPG](https://qiita-image-store.s3.amazonaws.com/0/129156/87ec6f97-a4e0-81b0-8f16-9133da812f21.jpeg)

初期状態で残ったキャラは以下の通りです。

- アリス・マーガトロイド
- クラウンピース
- ドレミー・スイート
- パチュリー・ノーレッジ
- フランドール・スカーレット
- マエリベリー・ハーン
- ミスティア・ローレライ
- レミリア・スカーレット
- 二ッ岩マミゾウ
- 八雲紫
- 十六夜咲夜
- 博麗霊夢
- 古明地こいし
- 古明地さとり
- 姫海棠はたて
- 宇佐見蓮子
- 射命丸文
- 本居小鈴
- 東風谷早苗
- 犬走椛
- 稀神サグメ
- 稗田阿求
- 茨木華扇
- 霧雨魔理沙
- 魂魄妖夢

学習が完了すると、試験結果も表示してくれます。特に何もしていないのでバランスが悪いですね…
学習結果と学習内容はIteration単位で保存されていますので、バージョン管理に活用できます。

検出の確信度閾値は左上のスライダーで調整できます。
よほど閾値を下げない限り、Precision>>>Recallとなっているので、そもそもキャラを拾い出すことに苦労している感じですね。

![キャプチャ.JPG](https://qiita-image-store.s3.amazonaws.com/0/129156/1570295a-0ef2-c5e3-f77b-fec6328c8ade.jpeg)

APIで結果を得ることもできるのですが、まずは画面上のQuick Testを使って、学習に使って**いない**電撃Playstationの表紙を判定させてみます。

![image.png](https://qiita-image-store.s3.amazonaws.com/0/129156/0721f3a5-bf6b-7efb-fdd1-2e2e62e989d7.png)

霊夢は正しく検出できました！魔理沙は…がんばりましょう。


## 3.学習内容を改善する

まだまだ使いものにならないのでもうちょっとマシな学習内容を目指します。
閾値を0にして確認すると、霊夢は12%の確率で魔理沙ですが魔理沙は1.9%の確率でしか魔理沙と思われていません。

![image.png](https://qiita-image-store.s3.amazonaws.com/0/129156/e9f5c168-2d0d-3630-4ff8-e90af1bc3e1b.png)

学習ロジックはいじれないので、学習データを下記の通りいじって再度Trainingします。だいたい5分から10分くらいでモデルが出来上がるので爆速と言って過言ではないでしょう。

- データの少ないキャラタグを削除
- 衣装変更（コート着・社会派ルポライターあや・他）を削除
- 学習データ追加

結果、下記のキャラ(数字はデータ枚数)が残りました。主人公sと書籍キャラが多く残りましたね…

- アリス・マーガトロイド17
- クラウンピース19
- ドレミー・スイート18
- パチュリー・ノーレッジ19
- フランドール・スカーレット19
- マエリベリー・ハーン22
- レミリア・スカーレット33
- 十六夜咲夜28
- 博麗霊夢54
- 古明地こいし18
- 古明地さとり17
- 姫海棠はたて19
- 宇佐見蓮子23
- 射命丸文45
- 本居小鈴24
- 東風谷早苗28
- 稀神サグメ25
- 稗田阿求22
- 茨木華扇18
- 霧雨魔理沙46
- 魂魄妖夢18


![image.png](https://qiita-image-store.s3.amazonaws.com/0/129156/f2d656b0-2ac8-a894-053f-d8aa61837ca5.png)

もう1度、電撃Playstationの表紙でテストします。

![image.png](https://qiita-image-store.s3.amazonaws.com/0/129156/bcc08fff-37c1-1120-c2b5-52c656556065.png)
未だ魔理沙発見できず。0%時の候補からも消えてしまいました。
他の画像でも霊夢が射命丸になったりするので、あまりいいモデルとは言えません。

仕事で作ったときのように、全タグの学習枚数を揃えると精度があがるかもしれませんが、時間がかかるので今回はここまでにします。

## 4.WEBアプリ化する

APIを用いてWEBアプリ化します。PredictionURLをクリックして、必要な情報を確認できます。

![image.png](https://qiita-image-store.s3.amazonaws.com/0/129156/00b386fd-599c-6259-b73f-335fe6798e76.png)

Vue.jsとAxiosを使って適当に実装します。公開するときはAPIキーを隠すべきですがとりあえずローカルで動かしたいだけなので気にせず直接書きます。
APIがJSON形式で検出したエリアを返してくるので、確信度でフィルタした後に画像にオーバーレイしてループしてボックス表示します。

もし流用する場合は`src/assets/App.vue`の{ProjectID},{PredictionID}を適当に置換して下さい。

Materializeを使って適当に装飾して、このように表示されます。
![image.png](https://qiita-image-store.s3.amazonaws.com/0/129156/6274e92e-8688-2281-f0cf-691d707145a0.png)
